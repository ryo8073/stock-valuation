name: å›½ç¨åºãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 18 * * 1'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # å›½ç¨åºãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•å–å¾—ãƒ»æ›´æ–°
  update-nta-data:
    name: å›½ç¨åºãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm ci
          cd backend && pip install -r requirements.txt && cd ..
          
      - name: ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.local
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> .env.local
          echo "EMAIL_SMTP_URL=${{ secrets.EMAIL_SMTP_URL }}" >> .env.local
          echo "WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}" >> .env.local
          echo "ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}" >> .env.local
          
      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
        run: |
          node -e "
            const { Pool } = require('pg');
            const pool = new Pool({ connectionString: process.env.DATABASE_URL });
            pool.query('SELECT 1').then(() => {
              console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ');
              process.exit(0);
            }).catch(err => {
              console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå¤±æ•—:', err);
              process.exit(1);
            });
          "
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          
      - name: å›½ç¨åºãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®å®Ÿè¡Œ
        run: |
          node api/cron/update-tax-data.js
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          EMAIL_SMTP_URL: ${{ secrets.EMAIL_SMTP_URL }}
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          
      - name: æ›´æ–°çµæœã®ç¢ºèª
        run: |
          node -e "
            const { Pool } = require('pg');
            const pool = new Pool({ connectionString: process.env.DATABASE_URL });
            
            Promise.all([
              pool.query('SELECT COUNT(*) as count FROM comparable_industry_data'),
              pool.query('SELECT COUNT(*) as count FROM dividend_reduction_rates'),
              pool.query('SELECT COUNT(*) as count FROM company_size_criteria'),
              pool.query('SELECT * FROM update_history ORDER BY check_date DESC LIMIT 1')
            ]).then(results => {
              console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆ:');
              console.log(`  é¡ä¼¼æ¥­ç¨®ãƒ‡ãƒ¼ã‚¿: ${results[0].rows[0].count}ä»¶`);
              console.log(`  é…å½“é‚„å…ƒç‡ãƒ‡ãƒ¼ã‚¿: ${results[1].rows[0].count}ä»¶`);
              console.log(`  ä¼šç¤¾è¦æ¨¡åˆ¤å®šåŸºæº–: ${results[2].rows[0].count}ä»¶`);
              
              if (results[3].rows.length > 0) {
                const latest = results[3].rows[0];
                console.log(`  æœ€æ–°æ›´æ–°: ${latest.check_date} (${latest.update_status})`);
              }
              
              process.exit(0);
            }).catch(err => {
              console.error('âŒ çµ±è¨ˆå–å¾—å¤±æ•—:', err);
              process.exit(1);
            });
          "
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  backup-database:
    name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    runs-on: ubuntu-latest
    needs: update-nta-data
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd backend && pip install -r requirements.txt && cd ..
          
      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å®Ÿè¡Œ
        run: |
          cd backend
          python scripts/backup_tax_data.py
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BACKUP_PATH: ./backups
          
      - name: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: backend/backups/
          retention-days: 30
          
      - name: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµæœã®é€šçŸ¥
        run: |
          if [ -f "backend/backups/backup_success.txt" ]; then
            echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆåŠŸ"
            # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
              curl -X POST -H 'Content-type: application/json' \
                --data "{\"text\":\"âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: ${{ github.run_number }}\"}" \
                ${{ secrets.SLACK_WEBHOOK_URL }}
            fi
          else
            echo "âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—"
            exit 1
          fi

  # ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
  health-check:
    name: ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    needs: [update-nta-data, backup-database]
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
        
      - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
        run: |
          # Vercelã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
          if [ -n "${{ secrets.VERCEL_HEALTH_CHECK_URL }}" ]; then
            response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.VERCEL_HEALTH_CHECK_URL }})
            if [ "$response" = "200" ]; then
              echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            else
              echo "âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯å¤±æ•—: HTTP $response"
              exit 1
            fi
          else
            echo "âš ï¸ VERCEL_HEALTH_CHECK_URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          fi
          
      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
        run: |
          node -e "
            const { Pool } = require('pg');
            const pool = new Pool({ connectionString: process.env.DATABASE_URL });
            
            Promise.all([
              pool.query('SELECT COUNT(*) as count FROM comparable_industry_data'),
              pool.query('SELECT COUNT(*) as count FROM dividend_reduction_rates'),
              pool.query('SELECT COUNT(*) as count FROM company_size_criteria'),
              pool.query('SELECT COUNT(*) as count FROM update_history'),
              pool.query('SELECT COUNT(*) as count FROM system_settings')
            ]).then(results => {
              const counts = results.map(r => r.rows[0].count);
              console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯:');
              console.log(`  é¡ä¼¼æ¥­ç¨®ãƒ‡ãƒ¼ã‚¿: ${counts[0]}ä»¶`);
              console.log(`  é…å½“é‚„å…ƒç‡ãƒ‡ãƒ¼ã‚¿: ${counts[1]}ä»¶`);
              console.log(`  ä¼šç¤¾è¦æ¨¡åˆ¤å®šåŸºæº–: ${counts[2]}ä»¶`);
              console.log(`  æ›´æ–°å±¥æ­´: ${counts[3]}ä»¶`);
              console.log(`  ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: ${counts[4]}ä»¶`);
              
              // æœ€å°ãƒ‡ãƒ¼ã‚¿é‡ãƒã‚§ãƒƒã‚¯
              if (counts[0] < 10 || counts[1] < 5 || counts[2] < 10) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                process.exit(1);
              }
              
              console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯æˆåŠŸ');
              process.exit(0);
            }).catch(err => {
              console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯å¤±æ•—:', err);
              process.exit(1);
            });
          "
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          
      - name: æœ€çµ‚çµæœã®é€šçŸ¥
        run: |
          echo "ğŸ‰ å…¨ã‚¸ãƒ§ãƒ–å®Œäº†"
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ğŸ‰ å›½ç¨åºãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: ${{ github.run_number }}\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi

  # ã‚¨ãƒ©ãƒ¼æ™‚ã®é€šçŸ¥
  notify-on-failure:
    name: ã‚¨ãƒ©ãƒ¼é€šçŸ¥
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã®é€ä¿¡
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"âŒ å›½ç¨åºãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${{ github.run_number }}\nè©³ç´°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi 